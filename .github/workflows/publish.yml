name: Publish

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

# Config Mapping
#
# - `DEPLOY_HOST` : host ssh URL
# - `DEPLOY_KEY` : ssh private key (see `authorized_keys` on host)
# - `DEPLOY_KEY_NAME` : ssh key file name 
# - `DEPLOY_KNOWN_HOSTS` : list of known hosts generated with `ssh-keyscan <YOUR_HOST>`
# - `DEPLOY_PATH` : path to folder on host machine
# - `DEPLOY_PORT` : ssh port
# - `DEPLOY_USER` : user name of deployer (user or domain)

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2.7.0
        if: ${{ github.event.release || contains( github.event.pull_request.labels.*.name, 'release') }}
        with:
          key: ${{ secrets.DEPLOY_KEY }}
          name: ${{ secrets.DEPLOY_KEY_NAME }}
          known_hosts: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
          if_key_exists: fail

      - name: Build info
        run: |
          JSON_STRING='{"job":"'"$GITHUB_JOB"'","ref":"'"$GITHUB_REF"'","run_id":"'"$GITHUB_RUN_ID"'","sha":"'"$GITHUB_SHA"'","runner_name":"'"$RUNNER_NAME"'","date":"'"$(date +'%Y-%m-%dT%H:%M:%S')"'"}'
          echo $JSON_STRING | jq > build_info

      - name: Assemble contents
        run: |
          mkdir -p ./_PUBLISH
          cp build_info ./_PUBLISH
          cp *.html ./_PUBLISH
          cp -r assets ./_PUBLISH

      - name: Deploy
        if: ${{ github.event.release || contains( github.event.pull_request.labels.*.name, 'release') }}
        run: |
          rsync -crvzh --progress -e 'ssh -p ${{ secrets.DEPLOY_PORT }} -i ~/.ssh/${{ secrets.DEPLOY_KEY_NAME }}' --delete-during ./_PUBLISH/* ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}
          rm -rdf ~/.ssh/${{ secrets.DEPLOY_KEY_NAME }}

      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v4.6.0
        if: ${{ success() }}
        with:
          name: dailygrindband.com
          path: ./_PUBLISH/*
          retention-days: 3
